<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebRTC Voice Chat</title>
  </head>
  <body>
    <h1>Room: <span id="roomId"></span></h1>
    <audio id="localAudio" autoplay muted></audio>
    <audio id="remoteAudio" autoplay></audio>
    <button id="startBtn">Start</button>

    <script>
      const url = new URL(location);
      const roomId = url.searchParams.get("room") || prompt("Room ID?");
      const userId = Math.random().toString(36).substr(2, 8);
      document.getElementById("roomId").textContent = roomId;

      const localAudio = document.getElementById("localAudio");
      const remoteAudio = document.getElementById("remoteAudio");
      const startBtn = document.getElementById("startBtn");

      const ws = new WebSocket(`ws://864e-114-10-142-211.ngrok-free.app/ws/${roomId}/${userId}`);
      const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
      });

      // 1) Tangkap audio lokal dan kirim track ke PeerConnection
      async function startLocal() {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        localAudio.srcObject = stream;
        stream.getTracks().forEach((t) => pc.addTrack(t, stream));
      }

      // 2) Ketika mendapat track remote, set ke audio element
      pc.ontrack = (e) => {
        remoteAudio.srcObject = e.streams[0];
      };

      // 3) Tangani ICE candidate: kirim ke signaling
      pc.onicecandidate = (e) => {
        if (e.candidate) {
          ws.send(JSON.stringify({ type: "ice", candidate: e.candidate }));
        }
      };

      // 4) Tangani pesan dari signaling server
      ws.onmessage = async (evt) => {
        const msg = JSON.parse(evt.data);

        if (msg.type === "offer") {
          await pc.setRemoteDescription(msg.offer);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: "answer", answer }));
        } else if (msg.type === "answer") {
          await pc.setRemoteDescription(msg.answer);
        } else if (msg.type === "ice") {
          await pc.addIceCandidate(msg.candidate);
        }
      };

      // 5) Mulai koneksi: host membuat offer, listener menunggu offer
      startBtn.onclick = async () => {
        await startLocal();
        // Hanya host yang memulai offer; kita anggap siapa pun yang klik pertama adalah host
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ type: "offer", offer }));
        startBtn.disabled = true;
      };
    </script>
  </body>
</html>
