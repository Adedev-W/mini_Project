<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebRTC Voice Chat</title>
  </head>
  <body>
    <h1>Room: <span id="roomId"></span></h1>
    <audio id="localAudio" autoplay muted></audio>
    <audio id="remoteAudio" autoplay></audio>
    <button id="startBtn">Start</button>

    <script>
      const url = new URL(location);
      const roomId = url.searchParams.get("room") || prompt("Room ID?");
      const userId = Math.random().toString(36).substr(2, 8);
      document.getElementById("roomId").textContent = roomId;

      const localAudio = document.getElementById("localAudio");
      const remoteAudio = document.getElementById("remoteAudio");
      const startBtn = document.getElementById("startBtn");

      // ganti dengan host ngrok-mu
      const ws = new WebSocket(`wss://14eb-114-10-142-211.ngrok-free.app/ws/${roomId}/${userId}`);
      const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
      });

      // 1) Ambil mic dan pasang ke PC
      async function startLocal() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        localAudio.srcObject = stream;
        stream.getTracks().forEach((t) => pc.addTrack(t, stream));
      }

      // 2) Pasang remote track ke audio element
      pc.ontrack = (e) => {
        remoteAudio.srcObject = e.streams[0];
      };

      // 3) Kirim ICE candidates ke server
      pc.onicecandidate = (e) => {
        if (e.candidate) {
          ws.send(JSON.stringify({ type: "ice", candidate: e.candidate }));
        }
      };

      // 4) Tangani pesan signaling
      ws.onmessage = async (evt) => {
        const msg = JSON.parse(evt.data);

        switch (msg.type) {
          case "offer":
            // terima offer dari peer, setRemote → buat answer → kirim answer
            await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: "answer", answer }));
            break;

          case "answer":
            // hanya terima answer jika kita sudah punya local-offer
            if (pc.signalingState === "have-local-offer") {
              await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
            }
            break;

          case "ice":
            // tambahkan ICE candidate
            try {
              await pc.addIceCandidate(msg.candidate);
            } catch (e) {
              console.warn("addIceCandidate error:", e);
            }
            break;
        }
      };

      // 5) Klik Start: ambil mic, buat & kirim offer
      startBtn.onclick = async () => {
        startBtn.disabled = true;
        await startLocal();

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ type: "offer", offer }));
      };
    </script>
  </body>
</html>
